
stages:
  - build-sonar
  - validate-env
  - docker-build
  - deploy-staging

image: 
  name: sonarsource/sonar-scanner-cli:11
  entrypoint: [""]

variables:
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
  GIT_DEPTH: "0"
  DOCKER_DRIVER: overlay2

build-sonar:
  stage: build-sonar
  tags:
    - gl-runner
  cache:
    policy: pull-push
    key: "sonar-cache-$CI_COMMIT_REF_SLUG"
    paths:
      - "${SONAR_USER_HOME}/cache"
      - Dsonar.exclusions=".gitlab-ci.yml,*.gitlab-ci.yml,Dockerfile*,*.dockerfile,.dockerignore,docker-compose*.yml"
      - sonar-scanner/
  script: 
  - sonar-scanner -Dsonar.host.url="${SONAR_HOST_URL}" -Dsonar.qualitygate.wait=true
  rules:
    - if: $CI_COMMIT_BRANCH == 'dev'

validate-env:
  stage: validate-env
  image: alpine:latest
  tags:
    - astratech
  script:
    - |
      echo "=== Validating environment file ==="
      
      if [ ! -f "$BUILD_ENV_FILE" ]; then
        echo "❌ ERROR: BUILD_ENV_FILE not found!"
        exit 1
      fi
      
      echo "✅ File found: $BUILD_ENV_FILE"
      echo "File size: $(wc -l < $BUILD_ENV_FILE) lines"
      
      # Validate required variables
      REQUIRED_VARS="NEXT_PUBLIC_BASE_URL NEXT_PUBLIC_API_URL"
      
      for var in $REQUIRED_VARS; do
        if grep -q "^${var}=" "$BUILD_ENV_FILE"; then
          value=$(grep "^${var}=" "$BUILD_ENV_FILE" | cut -d'=' -f2-)
          echo "✅ $var found"
        else
          echo "❌ $var MISSING!"
          exit 1
        fi
      done
      
      echo "✅ Validation passed"
  needs: ["build-sonar"]
  rules:
    - if: $CI_COMMIT_BRANCH == "dev"

docker-build:
  stage: docker-build
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  tags:
    - astratech
  script:
    - |
      cat > $CI_PROJECT_DIR/.env << EOF
      NEXT_PUBLIC_APP_NAME=ASTRATECH-APPS
      NEXT_PUBLIC_APP_VERSION=1.0.0
      NEXT_PUBLIC_BASE_URL=http://10.5.0.127:4001
      NEXT_PUBLIC_API_URL=http://10.5.0.127:4331/api/
      NEXT_PUBLIC_KEY=$PROJECT_NEXT_KEY
      MAX_FILE_SIZE=5242880
      ALLOWED_FILE_TYPES=jpg,jpeg,png,mp4,pdf,docx,xlsx,pptx,zip
      NODE_ENV=production
      EOF
    
    - test -f $CI_PROJECT_DIR/.env && echo "✅ Configuration ready" || exit 1
    
    - echo "{\"auths\":{\"https://index.docker.io/v1/\":{\"username\":\"$DOCKER_USERNAME\",\"password\":\"$DOCKER_PASSWORD\"}}}" > /kaniko/.docker/config.json
    
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/Dockerfile --destination=$DOCKER_USERNAME/defesia:$CI_COMMIT_SHA
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/Dockerfile --destination=$DOCKER_USERNAME/defesia:latest
  when: on_success
  needs: ["build-sonar", "validate-env"]
  rules:
    - if: $CI_COMMIT_BRANCH == "dev"

deploy-staging:
  stage: deploy-staging
  when: on_success
  needs: ["docker-build"]
  only: 
    - dev
  image: curlimages/curl:latest
  tags:
    - astratech
  services:
    - docker:dind
  script:
    - curl --user Developer:$JENKINS_PWD $JENKINS_DEPLOY_URL
